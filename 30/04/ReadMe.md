# [4.7.7. 関数のアノテーション](https://docs.python.jp/3/tutorial/controlflow.html#function-annotations)

< [4.7. 関数定義についてもう少し](https://docs.python.jp/3/tutorial/controlflow.html#more-on-defining-functions) < [4. その他の制御フローツール](https://docs.python.jp/3/tutorial/controlflow.html#more-control-flow-tools) < [Python チュートリアル](https://docs.python.jp/3/tutorial/index.html) < [ドキュメント](https://docs.python.jp/3/index.html)

前回、深追いして蛇足になった。今回もドキュメントを信じてサクっと終わらせる。「関数のアノテーション」という概念の存在を知るだけに留める。

## 関数のアノテーション

> 関数のアノテーション はユーザ定義関数で使用される型についての完全にオプションなメタデータ情報です (詳細は [PEP 484](https://www.python.org/dev/peps/pep-0484) を参照してください)。

リンク先の文章は英語だし長いので読まない。

## `__annotations__`

> アノテーションは関数の __annotations__ 属性に辞書として格納され、関数の他の部分には何も影響がありません。

```python
def intro(name: str, age: int) -> str:
    print(intro.__annotations__)
    return "私は{0}です。{1}歳です。".format(name, age)

print(intro('山田', 999))
```
```sh
$ python3 0.py 
{'return': <class 'str'>, 'name': <class 'str'>, 'age': <class 'int'>}
私は山田です。999歳です。
```

関数のアノテーションは、引数と戻り値の型におけるメタデータを指定するもの。

## エラーは出してくれない

```python
def intro(name: str, age: int) -> str:
    print(intro.__annotations__)
    return "私は{0}です。{1}歳です。".format(name, age)

print(intro(None, 'abc'))
```
```sh
$ python3 1.py
{'name': <class 'str'>, 'age': <class 'int'>, 'return': <class 'str'>}
私はNoneです。abc歳です。
```

静的型付けはできない。エラーにしてくれないならどんな価値があるのだろうか。

## デフォルト値を指定すると読みづらい

```python
def intro(name: str='default', age: int=100) -> str:
    print(intro.__annotations__)
    return "私は{0}です。{1}歳です。".format(name, age)

print(intro(None, 'abc'))
print(intro())
```

`変数名: 型 = 値`。まるで型に値を代入しているように見える。ふつうは、`型 変数名 = 値`の順。それに倣っていないので非常に見づらい。後から無理やり取ってつけたような見づらい構文。

## 問題点

関数のアノテーションを使うことによる問題点は以下。

* バージョンによってはSyntaxErrorになる
    * 少なくともPython 2.7.6ではエラー
    * 3.4.3, 3.6.1ではOK
* 可読性の低下
    * 読みやすさを謳うPythonとしてはいかがなものか
* コンパイルエラーとして知らせてくれるわけでもない

役に立たないメタデータを時間を掛けて書いた結果、コードを見づらくした上、環境次第では実行時エラーを起こすコードに仕立ててしまう。もはや使う理由などどこにもないように思える。一体何のための機能なのか。

### 調べてみた

http://t2y.hatenablog.jp/entry/20111211/1323590210

かなり複雑そう。アノテーションを使って自動化するサードパーティ製ライブラリを実装するなど、自力で活用するしかなさそう。

## 利用価値はあるか？

Pythonで関数アノテーションを使うくらいなら、素直に静的型付けできる言語でプログラミングしたほうが良いのでは？

[チュートリアルの最初](https://docs.python.jp/3/tutorial/appetite.html)でPythonのメリットとして以下を謳っていた。

* 短く書ける
    * 高レベルのデータ型によって、複雑な操作を一つの実行文で表現できる
        * 読みやすい

関数アノテーションを使うことは、[チュートリアルの最初](https://docs.python.jp/3/tutorial/appetite.html)で言っていたメリットを犠牲にすることになる気がする。

かわりにデメリットが引き立つ。関数アノテーションのせいで短く書くことが出来ない上に、コンパイルエラーが出ず実行時エラーになる言語仕様。単体テストが必要になる。アノテーションで実行時エラーを減らせる仕組みを作れるのかもしれないが、その実装はユーザがせねばならない。短く書くことができない。

### 他の言語にすべき？

関数アノテーションが何のためにあるのかわからない。仮に静的型付けのかわりをするための機能なのだとしたら、素直に静的型付けできる言語に乗り換えたほうがいい気もする。それをユーザが実装せねばならない時点で論外。コードも後付け構文で見づらくなってしまう。手間暇かけた結果、改善どころか悪化してしまうなら使わないほうが良い。

おそらく静的型付けしないことがデメリットであり、メリットでもある。どんな型でも受け付けることができる点はメリットにもなる。融通がきく。しかし、規模が大きいコードになるとデメリットのほうが大きくなる。エラーチェック処理や単体テストの項目が増えてしまうことで、時間を奪われる。関数アノテーションではそれをカバーする目的なのかもしれない。しかし中途半端なせいでメリットが死に、デメリットが際立つように思える。私が使い方を知らないだけかもしれないが。

Pythonが最も生きるのは、小規模のスクリプトを短く書くときか。規模が大きくなったら静的型付けできる言語のほうがテストも少なくバグの少ないコードが書けるのではないか？

### 使わない

少なくとも入門者の私には利用価値がわからなかった。メリットよりデメリットのほうが大きいように思える。今回は「関数アノテーションは使わない」という結論をもって終わる。

